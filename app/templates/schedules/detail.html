{% extends "base.html" %}
{% block title %}Schedule {{ run.id }} · Payroll Desk{% endblock %}
{% block content %}
<section class="page-header">
    <div>
        <h1 class="page-title">{{ '%02d/%04d'|format(run.target_month, run.target_year) }} Payroll</h1>
        <p>Generated {{ run.created_at.strftime('%m/%d/%Y') }} · Currency {{ run.currency }}</p>
    </div>
    <div class="download-links">
        <a class="button" href="/schedules/{{ run.id }}/download/schedule_csv">Export Schedule</a>
    </div>
</section>

<section class="metrics">
    <div class="metric">
        <div class="metric-title">Paid This Run</div>
    <div class="metric-value">{{ summary.paid_total|money }}</div>
    </div>
    <div class="metric">
        <div class="metric-title">Unpaid This Run</div>
    <div class="metric-value">{{ summary.unpaid_total|money }}</div>
    </div>
    <div class="metric">
        <div class="metric-title">Models Paid</div>
        <div class="metric-value">{{ summary.paid_models }}</div>
    </div>
    <div class="metric">
        <div class="metric-title">Lifetime Paid</div>
    <div class="metric-value">{{ summary.overall_paid|money }}</div>
    </div>
    <div class="metric">
        <div class="metric-title">Status Mix</div>
        <div class="metric-value metric-value-small">
            {% for option in status_options %}
                {{ option.replace('_', ' ')|title }}: {{ status_counts.get(option, 0) }}{% if not loop.last %} · {% endif %}
            {% else %}
                n/a
            {% endfor %}
        </div>
    </div>
    <div class="metric">
        <div class="metric-title">Frequency Mix</div>
        <div class="metric-value metric-value-small">
            {% for name, count in frequency_counts.items() %}
                {{ name }}: {{ count }}{% if not loop.last %} · {% endif %}
            {% else %}
                n/a
            {% endfor %}
        </div>
    </div>
    <div class="metric">
        <div class="metric-title">Export Folder</div>
        <div class="metric-value metric-value-small">{{ export_dir }}</div>
    </div>
</section>

<section class="card" style="margin-top: 32px;">
    <h2>Payouts</h2>
    <form class="filter-bar" method="get" action="/schedules/{{ run.id }}">
        <div class="filter-group">
            <label for="filter-code">Model Code</label>
            <select id="filter-code" name="code">
                <option value="">All</option>
                {% for option in code_options %}
                    <option value="{{ option }}" {% if filters.code == option %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="filter-pay-date">Pay Date</label>
            <select id="filter-pay-date" name="pay_date">
                <option value="">All dates</option>
                {% for option in pay_date_options %}
                    <option value="{{ option.value }}" {% if filters.pay_date == option.value %}selected{% endif %} {% if not option.available %}disabled{% endif %}>{{ option.label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="filter-frequency">Frequency</label>
            <select id="filter-frequency" name="frequency">
                <option value="">All</option>
                {% for value in frequency_options %}
                    <option value="{{ value }}" {% if filters.frequency == value %}selected{% endif %}>{{ value|title }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="filter-method">Payment Method</label>
            <select id="filter-method" name="payment_method">
                <option value="">All</option>
                {% for value in payment_methods %}
                    <option value="{{ value }}" {% if filters.payment_method == value %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="filter-status">Status</label>
            <select id="filter-status" name="status">
                <option value="">All</option>
                {% for option in status_options %}
                    <option value="{{ option }}" {% if filters.status == option %}selected{% endif %}>{{ option.replace('_', ' ')|title }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-actions">
            <button class="button" type="submit">Apply Filters</button>
            <a class="button secondary" href="/schedules/{{ run.id }}">Reset</a>
        </div>
    </form>
    
    <table class="data-table">
        <thead>
            <tr>
                <th style="width: 30px;">
                    <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)">
                </th>
                <th onclick="sortTable(1)" style="cursor: pointer; user-select: none;">Pay Date ▼</th>
                <th onclick="sortTable(2)" style="cursor: pointer; user-select: none;">Code ▼</th>
                <th onclick="sortTable(3)" style="cursor: pointer; user-select: none;">Working Name ▼</th>
                <th onclick="sortTable(4)" style="cursor: pointer; user-select: none;">Method ▼</th>
                <th onclick="sortTable(5)" style="cursor: pointer; user-select: none;">Frequency ▼</th>
                <th onclick="sortTable(6)" style="cursor: pointer; user-select: none;">Amount ▼</th>
                <th onclick="sortTable(7)" style="cursor: pointer; user-select: none;">Status ▼</th>
                <th>Notes &amp; Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for payout in payouts %}
            <tr>
                <td style="text-align: center;">
                    <input type="checkbox" class="payout-checkbox" value="{{ payout.id }}" onchange="updateBulkSection()">
                </td>
                <td>{{ payout.pay_date.strftime('%m/%d/%Y') }}</td>
                <td>{{ payout.code }}</td>
                <td>{{ payout.working_name }}</td>
                <td>{{ payout.payment_method }}</td>
                <td>{{ payout.payment_frequency|title }}</td>
                <td>{{ payout.amount|money }}</td>
                <td>
                    <span class="status-badge status-{{ payout.status }}">{{ payout.status.replace('_', ' ')|title }}</span>
                </td>
                <td>
                    <form class="note-form" method="post" action="/schedules/{{ run.id }}/payouts/{{ payout.id }}/note" style="display: flex; gap: 8px; align-items: center;">
                        <select name="status" aria-label="Payout status" onchange="this.form.submit()" style="padding: 6px; background: rgba(15, 23, 42, 0.7); color: #f8fafc; border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 4px;">
                            {% for option in status_options %}
                                <option value="{{ option }}" {% if payout.status == option %}selected{% endif %}>{{ option.replace('_', ' ')|title }}</option>
                            {% endfor %}
                        </select>
                        <textarea name="notes" placeholder="Add context..." aria-label="Payout notes" style="flex: 1; padding: 6px; background: rgba(15, 23, 42, 0.7); color: #f8fafc; border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 4px; min-height: 38px; font-family: inherit;">{{ payout.notes or '' }}</textarea>
                        <button class="button secondary" type="submit" title="Save notes">Save Notes</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td class="empty-state" colspan="9">No payouts scheduled for this run.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Bulk Update Form - positioned at bottom -->
    <div class="bulk-update-section" style="display: none; margin-top: 24px; padding: 20px; background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(148, 163, 184, 0.08); border-radius: 16px;">
        <h3 style="margin-top: 0; margin-bottom: 16px; color: #f8fafc;">Bulk Update Selected Payouts</h3>
        <form method="post" action="/schedules/{{ run.id }}/payouts/bulk-update" id="bulk-form">
            <input type="hidden" id="bulk-payout-ids" name="payout_ids" value="">
            <div style="display: flex; gap: 16px; align-items: flex-end;">
                <div style="flex: 0 0 200px;">
                    <label for="bulk-status" style="color: #cbd5e1; font-weight: 600; display: block; margin-bottom: 8px;">Status</label>
                    <select id="bulk-status" name="status" style="width: 100%; padding: 8px; background: rgba(15, 23, 42, 0.7); color: #f8fafc; border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 6px;">
                        {% for option in status_options %}
                            <option value="{{ option }}">{{ option.replace('_', ' ')|title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="button" type="submit">Apply to Selected</button>
                    <button class="button secondary" type="button" onclick="cancelBulkUpdate()">Cancel</button>
                </div>
            </div>
        </form>
    </div>
</section>

<section class="card" style="margin-top: 32px;">
    <h2>Validation Messages</h2>
    <table class="data-table">
        <thead>
            <tr>
                <th>Severity</th>
                <th>Model</th>
                <th>Issue</th>
            </tr>
        </thead>
        <tbody>
            {% for item in validations %}
            <tr>
                <td>{{ item.severity }}</td>
                <td>{{ item.model.code if item.model else '' }}</td>
                <td>{{ item.issue }}</td>
            </tr>
            {% else %}
            <tr>
                <td class="empty-state" colspan="3">No validation issues recorded.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>

<script>
function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.payout-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    updateBulkSection();
}

function updateBulkSection() {
    const checkboxes = document.querySelectorAll('.payout-checkbox:checked');
    const bulkSection = document.querySelector('.bulk-update-section');
    
    if (checkboxes.length > 0) {
        bulkSection.style.display = 'block';
        const ids = Array.from(checkboxes).map(cb => cb.value).join(',');
        document.getElementById('bulk-payout-ids').value = ids;
    } else {
        bulkSection.style.display = 'none';
    }
}

function cancelBulkUpdate() {
    document.querySelectorAll('.payout-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('select-all').checked = false;
    updateBulkSection();
}

let sortDirection = {};

function sortTable(columnIndex) {
    const table = document.querySelector('.data-table');
    const tbody = table.querySelector('tbody');
    let rows = Array.from(tbody.querySelectorAll('tr'));

    // Remove empty state row if present
    const emptyStateRow = rows.find(r => r.querySelector('.empty-state'));
    if (emptyStateRow) rows = rows.filter(r => !r.querySelector('.empty-state'));

    if (rows.length === 0) return;

    // Toggle sort direction: if previously true (ascending) then next is descending, and vice-versa.
    const prev = sortDirection[columnIndex] === true;
    const isAscending = !prev;
    sortDirection = {}; // reset others
    sortDirection[columnIndex] = isAscending;

    // Sort rows
    rows.sort((rowA, rowB) => {
        const cellA = (rowA.cells[columnIndex] && rowA.cells[columnIndex].textContent || '').trim();
        const cellB = (rowB.cells[columnIndex] && rowB.cells[columnIndex].textContent || '').trim();

        // Date sort (MM/DD/YYYY format) - handle first so dates containing numbers don't get numeric sort
        if (columnIndex === 1) {
            const parse = s => {
                const parts = s.split('/');
                if (parts.length === 3) return new Date(`${parts[2]}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`);
                return new Date(s);
            };
            const dateA = parse(cellA);
            const dateB = parse(cellB);
            return isAscending ? dateA - dateB : dateB - dateA;
        }

        // Try numeric sort (Amount)
        const numA = parseFloat(cellA.replace(/[^\d.-]/g, ''));
        const numB = parseFloat(cellB.replace(/[^\d.-]/g, ''));
        if (!isNaN(numA) && !isNaN(numB)) {
            return isAscending ? numA - numB : numB - numA;
        }

        // String sort
        return isAscending ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
    });

    // Reappend sorted rows
    rows.forEach(row => tbody.appendChild(row));

    // Update header indicators (only for sortable columns: indices 1..7)
    document.querySelectorAll('.data-table th').forEach((th, idx) => {
        // Base label is header text without arrows
        const base = th.textContent.replace(/\s*[▲▼]\s*$/, '').trim();
        if (idx === columnIndex) {
            th.textContent = base + (isAscending ? ' ▲' : ' ▼');
        } else if (idx > 0 && idx < 8) {
            // show default descending indicator for other sortable columns
            th.textContent = base + ' ▼';
        } else {
            th.textContent = base;
        }
    });
}
</script>

{% endblock %}
