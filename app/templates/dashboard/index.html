{% extends "base.html" %}
{% block title %}Dashboard · Payroll Desk{% endblock %}
{% block content %}
<section class="page-header">
    <div>
        <h1 class="page-title">Operations Dashboard</h1>
        <p>At-a-glance metrics for payroll performance and data quality.</p>
    </div>
    <div class="header-actions">
        {% if user and user.is_admin() %}
        <button id="exportAllBtn" class="button">Export All Data (XLSX)</button>
        {% endif %}
    </div>
</section>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const btn = document.getElementById('exportAllBtn');
    if (!btn) return;
    btn.addEventListener('click', async () => {
        btn.disabled = true;
        btn.textContent = 'Preparing export...';
        try {
            const resp = await fetch('/dashboard/export-xlsx', { credentials: 'same-origin' });
            if (!resp.ok) {
                throw new Error(`Export failed: ${resp.status}`);
            }
            const blob = await resp.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            // Try to derive filename from Content-Disposition
            const cd = resp.headers.get('Content-Disposition') || '';
            const match = /filename=(.+)$/i.exec(cd);
            const filename = match ? match[1].replace(/"/g, '') : 'payroll_export.xlsx';
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
        } catch (err) {
            console.error(err);
            alert('Export failed. Check console for details.');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Export All Data (XLSX)';
        }
    });
});
</script>

<section class="metrics">
    {% if summary.latest_run_is_current_month %}
        {% set run_paid_title = 'Current Month Paid' %}
        {% set run_outstanding_title = 'Current Month Outstanding' %}
        {% set run_detail_title = 'Current Month Run' %}
    {% else %}
        {% set run_paid_title = 'Latest Run Paid' %}
        {% set run_outstanding_title = 'Latest Run Outstanding' %}
        {% set run_detail_title = 'Latest Run' %}
    {% endif %}
    <div class="metric">
        <div class="metric-title">Total Models</div>
        <div class="metric-value">{{ summary.total_models }}</div>
    </div>
    <div class="metric">
        <div class="metric-title">Active Models</div>
        <div class="metric-value">{{ summary.active_models }}</div>
    </div>
    <div class="metric">
        <div class="metric-title">Inactive Models</div>
        <div class="metric-value">{{ summary.inactive_models }}</div>
    </div>
    <div class="metric">
        <div class="metric-title">Lifetime Paid</div>
    <div class="metric-value">${{ summary.lifetime_paid|money }}</div>
    </div>
    <div class="metric">
        <div class="metric-title">Total Outstanding</div>
    <div class="metric-value">${{ summary.outstanding_total|money }}</div>
    </div>
    <div class="metric">
        <div class="metric-title">Pending Payouts</div>
        <div class="metric-value">{{ summary.pending_count }}</div>
    </div>
    <div class="metric">
        <div class="metric-title">On Hold</div>
        <div class="metric-value">{{ summary.on_hold_count }}</div>
    </div>
    <div class="metric">
        <div class="metric-title">Total Runs</div>
        <div class="metric-value">{{ summary.total_runs }}</div>
    </div>
    <div class="metric">
        <div class="metric-title">{{ run_paid_title }}</div>
        <div class="metric-value">${{ summary.latest_run_paid|money }}</div>
    </div>
    <div class="metric">
        <div class="metric-title">{{ run_outstanding_title }}</div>
        <div class="metric-value">${{ summary.latest_run_unpaid|money }}</div>
    </div>
    {% if summary.latest_run %}
    <div class="metric" style="grid-column: span 2;">
        <div class="metric-title">{{ run_detail_title }}</div>
        <div class="metric-value" style="font-size: 1.1rem;">
            {{ summary.latest_run.cycle_display }} ·
            Generated {{ summary.latest_run.created_at|display_date }}
        </div>
    </div>
    {% endif %}
</section>

<section class="card-grid columns-3" style="margin-top: 32px;">
    <div class="card">
        <div class="card-heading">
            <h2>Recent Runs</h2>
            <a class="button secondary button--compact" href="/schedules">Open Runs Table</a>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Run</th>
                    <th>Created</th>
                    <th>Currency</th>
                    <th>Total</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for run in recent_runs %}
                <tr>
                    <td>{{ run.cycle_display }}</td>
                    <td>{{ run.created_at|display_date }}</td>
                    <td>{{ run.currency }}</td>
                    <td>${{ run.summary_total_payout|money }}</td>
                    <td><a class="link-button" href="/schedules/{{ run.id }}">Open</a></td>
                </tr>
                {% else %}
                <tr>
                    <td class="empty-state" colspan="5">Run payroll to populate this list.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="card">
        <div class="card-heading">
            <h2>Top Paid Models</h2>
            <a class="button secondary button--compact" href="/models">Open Models Table</a>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Model</th>
                    <th>Status</th>
                    <th>Total Paid</th>
                </tr>
            </thead>
            <tbody>
                {% for item in top_models %}
                <tr>
                    <td>{{ item.code }} · {{ item.working_name }}</td>
                    <td>
                        {% if item.status == 'Active' %}
                            <span class="tag active">Active</span>
                        {% else %}
                            <span class="tag inactive">Inactive</span>
                        {% endif %}
                    </td>
                    <td>${{ item.total_paid|money }}</td>
                </tr>
                {% else %}
                <tr>
                    <td class="empty-state" colspan="3">No payouts recorded yet.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="card">
        <div class="card-heading">
            <h2>Pending Ad Hoc Payments</h2>
            <a class="button secondary button--compact" href="/schedules">Manage Ad Hoc Payments</a>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Pay Date</th>
                    <th>Model</th>
                    <th>Amount</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for payment in pending_adhoc_payments %}
                <tr>
                    <td>{{ payment.pay_date|display_date or '—' }}</td>
                    <td>
                        {% if payment.model_name %}
                            {{ payment.model_name }}
                            {% if payment.model_code %}
                                <span class="table-subtle">· {{ payment.model_code }}</span>
                            {% endif %}
                        {% else %}
                            {{ payment.model_code or '—' }}
                        {% endif %}
                    </td>
                    <td>${{ payment.amount|money }}</td>
                    <td>{{ payment.status|replace('_', ' ')|title }}</td>
                </tr>
                {% else %}
                <tr>
                    <td class="empty-state" colspan="4">No pending ad hoc payments.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endblock %}
