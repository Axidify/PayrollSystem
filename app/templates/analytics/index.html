{% extends "base.html" %}
{% block title %}Analytics · Payroll Desk{% endblock %}
{% block content %}
<section class="page-header">
    <div>
        <h1 class="page-title">Custom Analytics</h1>
        <p>Pick the datasets and date range to explore transactions captured by Payroll Desk.</p>
    </div>
</section>

<section class="card card--filters">
    <header class="filter-card__header">
        <div>
            <h2>Filter Analytics</h2>
            <p class="filter-card__description">Choose a date range and datasets to generate on-demand analytics for payouts, adjustments, and runs.</p>
        </div>
        <div class="filter-card__actions">
            <button class="button" type="submit" form="analytics-form">Run Analytics</button>
            <button class="button secondary" type="button" id="analytics-reset">Reset</button>
        </div>
    </header>
    <form id="analytics-form" class="filter-card__form">
        <div class="filter-group">
            <label for="analytics-start">Start Date</label>
            <input id="analytics-start" name="start" type="date" value="{{ default_start }}" required>
        </div>
        <div class="filter-group">
            <label for="analytics-end">End Date</label>
            <input id="analytics-end" name="end" type="date" value="{{ default_end }}" required>
        </div>
        <div class="quick-range-buttons" id="analytics-quick-ranges">
            <button class="button secondary" type="button" data-range="past_7_days" data-days="7">Past 7 Days</button>
            <button class="button secondary" type="button" data-range="past_30_days" data-days="30">Past 30 Days</button>
            <button class="button secondary" type="button" data-range="past_3_months" data-months="3">Past 3 Months</button>
            <button class="button secondary" type="button" data-range="past_6_months" data-months="6">Past 6 Months</button>
            <button class="button secondary" type="button" data-range="past_1_year" data-months="12">Past 1 Year</button>
        </div>
        <fieldset class="filter-group" style="min-width: 220px;">
            <legend>Datasets</legend>
            {% for option in dataset_options %}
            <label class="checkbox-inline">
                <input type="checkbox" name="datasets" value="{{ option.id }}" {% if option.id == 'payouts' %}checked{% endif %}>
                {{ option.label }}
            </label>
            {% endfor %}
        </fieldset>
    </form>
</section>

<section class="card" id="analytics-summary" hidden>
    <h2>Summary</h2>
    <div class="analytics-summary-grid">
        <div>
            <p class="analytics-summary-label">Date Range</p>
            <p class="analytics-summary-value" id="analytics-range"></p>
        </div>
        <div>
            <p class="analytics-summary-label">Datasets</p>
            <p class="analytics-summary-value" id="analytics-datasets"></p>
        </div>
        <div>
            <p class="analytics-summary-label">Records Returned</p>
            <p class="analytics-summary-value" id="analytics-counts"></p>
        </div>
    </div>
    <div class="analytics-totals-grid">
        <article class="analytics-total-card analytics-total-card--paid">
            <p class="analytics-summary-label">Paid Amount</p>
            <p class="analytics-summary-value analytics-summary-value--emphasis" id="analytics-paid-total">0.00</p>
        </article>
        <article class="analytics-total-card analytics-total-card--unpaid">
            <p class="analytics-summary-label">Not Paid Amount</p>
            <p class="analytics-summary-value analytics-summary-value--emphasis" id="analytics-unpaid-total">0.00</p>
        </article>
    </div>
</section>

<section class="card" id="analytics-results">
    <h2>Results</h2>
    <div id="analytics-placeholder" class="empty-state">Select datasets and run analytics to see results.</div>
    <div id="analytics-tables"></div>
</section>

<script>
(function() {
    const form = document.getElementById('analytics-form');
    const resetButton = document.getElementById('analytics-reset');
    const placeholder = document.getElementById('analytics-placeholder');
    const summaryCard = document.getElementById('analytics-summary');
    const rangeField = document.getElementById('analytics-range');
    const datasetsField = document.getElementById('analytics-datasets');
    const countsField = document.getElementById('analytics-counts');
    const paidField = document.getElementById('analytics-paid-total');
    const unpaidField = document.getElementById('analytics-unpaid-total');
    const tablesContainer = document.getElementById('analytics-tables');
    const quickRangeContainer = document.getElementById('analytics-quick-ranges');
    const startInput = document.getElementById('analytics-start');
    const endInput = document.getElementById('analytics-end');
    let activeQuickRange = null;

    function formatAmount(value) {
        return Number(value || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function daysInMonth(year, monthIndex) {
        return new Date(year, monthIndex + 1, 0).getDate();
    }

    function subtractMonths(date, months) {
        let year = date.getFullYear();
        let monthIndex = date.getMonth() - months;
        const day = date.getDate();
        while (monthIndex < 0) {
            monthIndex += 12;
            year -= 1;
        }
        const maxDay = daysInMonth(year, monthIndex);
        const adjustedDay = Math.min(day, maxDay);
        return new Date(year, monthIndex, adjustedDay);
    }

    function clearQuickRangeState() {
        activeQuickRange = null;
        if (!quickRangeContainer) {
            return;
        }
        quickRangeContainer.querySelectorAll('.button').forEach((button) => {
            button.classList.remove('active');
            if (!button.classList.contains('secondary')) {
                button.classList.add('secondary');
            }
        });
    }

    function setQuickRange(button) {
        const today = new Date();
        let startDate = null;
        const days = button.getAttribute('data-days');
        const months = button.getAttribute('data-months');
        if (days) {
            const dayCount = parseInt(days, 10);
            startDate = new Date(today);
            startDate.setDate(today.getDate() - (dayCount - 1));
        } else if (months) {
            const monthCount = parseInt(months, 10);
            startDate = subtractMonths(today, monthCount);
        }
        if (!startDate) {
            return;
        }
        startInput.value = formatDate(startDate);
        endInput.value = formatDate(today);
        activeQuickRange = button.getAttribute('data-range');
        if (quickRangeContainer) {
            quickRangeContainer.querySelectorAll('.button').forEach((btn) => {
                if (btn === button) {
                    btn.classList.add('active');
                    btn.classList.remove('secondary');
                } else {
                    btn.classList.remove('active');
                    if (!btn.classList.contains('secondary')) {
                        btn.classList.add('secondary');
                    }
                }
            });
        }
    }

    function serializeForm() {
        const formData = new FormData(form);
        const params = new URLSearchParams();
        const start = formData.get('start');
        const end = formData.get('end');
        params.set('start', start);
        params.set('end', end);
        const datasets = formData.getAll('datasets');
        if (datasets.length) {
            params.set('datasets', datasets.join(','));
        }
        return params;
    }

    function renderTable(title, rows) {
        if (!rows.length) {
            return `<div class="analytics-table">\n<h3>${title}</h3>\n<p class="empty-state" style="margin: 12px 0;">No records in range.</p>\n</div>`;
        }
        const columns = Object.keys(rows[0]);
        const header = columns.map((column) => `<th>${column.replace(/_/g, ' ')}</th>`).join('');
        const body = rows.map((row) => {
            const cells = columns.map((column) => `<td>${row[column] ?? ''}</td>`).join('');
            return `<tr>${cells}</tr>`;
        }).join('');
        return `<div class="analytics-table">\n<h3>${title}</h3>\n<div class="analytics-table-wrapper">\n<table class="data-table">\n<thead><tr>${header}</tr></thead>\n<tbody>${body}</tbody>\n</table>\n</div>\n</div>`;
    }

    async function runAnalytics() {
        placeholder.textContent = 'Loading…';
        placeholder.hidden = false;
        tablesContainer.innerHTML = '';

        const params = serializeForm();
        try {
            const response = await fetch(`/analytics/data?${params.toString()}`);
            if (!response.ok) {
                throw new Error(`Request failed with status ${response.status}`);
            }
            const payload = await response.json();
            const { meta, results } = payload;

            rangeField.textContent = `${meta.start} → ${meta.end}`;
            datasetsField.textContent = meta.datasets.join(', ') || 'None';
            const counts = Object.entries(meta.counts).map(([key, value]) => `${key}: ${value}`).join(' · ');
            countsField.textContent = counts || '0';
            const totals = (meta && meta.totals) || {};
            paidField.textContent = formatAmount(totals.paid);
            unpaidField.textContent = formatAmount(totals.unpaid);
            summaryCard.hidden = false;

            const fragments = [];
            for (const [key, rows] of Object.entries(results)) {
                const title = key.replace(/_/g, ' ').replace(/\b\w/g, (char) => char.toUpperCase());
                fragments.push(renderTable(title, rows));
            }
            tablesContainer.innerHTML = fragments.join('');
            placeholder.hidden = true;
            if (!fragments.length) {
                placeholder.textContent = 'No data returned for the selected filters.';
                placeholder.hidden = false;
            }
        } catch (error) {
            placeholder.textContent = error.message || 'Unable to fetch analytics data.';
            placeholder.hidden = false;
            summaryCard.hidden = true;
            tablesContainer.innerHTML = '';
            paidField.textContent = '0.00';
            unpaidField.textContent = '0.00';
        }
    }

    function handleFormSubmit(event) {
        event.preventDefault();
        runAnalytics();
    }

    function resetFilters() {
        startInput.value = '{{ default_start }}';
        endInput.value = '{{ default_end }}';
        form.querySelectorAll('input[name="datasets"]').forEach((input) => {
            input.checked = input.value === 'payouts';
        });
        placeholder.hidden = false;
        placeholder.textContent = 'Select datasets and run analytics to see results.';
        summaryCard.hidden = true;
        tablesContainer.innerHTML = '';
        paidField.textContent = '0.00';
        unpaidField.textContent = '0.00';
        clearQuickRangeState();
    }

    form.addEventListener('submit', handleFormSubmit);
    resetButton.addEventListener('click', resetFilters);
    if (quickRangeContainer) {
        quickRangeContainer.querySelectorAll('.button').forEach((button) => {
            button.addEventListener('click', () => {
                setQuickRange(button);
                runAnalytics();
            });
        });
    }
    if (startInput) {
        startInput.addEventListener('input', clearQuickRangeState);
    }
    if (endInput) {
        endInput.addEventListener('input', clearQuickRangeState);
    }
})();
</script>
{% endblock %}
