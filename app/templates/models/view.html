{% extends "base.html" %}
{% block title %}{{ model.working_name }} · Model Details · Payroll Desk{% endblock %}
{% block content %}
<section class="page-header">
    <div>
        <h1 class="page-title">{{ model.working_name }}</h1>
        <p>View-only model details</p>
    </div>
    <div>
        <a class="button secondary" href="/models">Back to Roster</a>
    </div>
</section>

{% if error_message %}
<div class="alert error">
    <strong>Could not complete request.</strong> {{ error_message }}
</div>
{% endif %}
{% if success_message %}
<div class="alert success">
    <strong>Done.</strong> {{ success_message }}
</div>
{% endif %}

<section class="card card--form">
    <header class="card-heading">
        <h2>Model Information</h2>
        <p>Roster and payment configuration</p>
    </header>
    <div class="info-grid two-column">
        <div class="info-field">
            <span class="info-label">Status</span>
            <span class="info-value">
                {% if model.status == 'Active' %}
                    <span class="status-chip status-chip--active">Active</span>
                {% else %}
                    <span class="status-chip status-chip--inactive">Inactive</span>
                {% endif %}
            </span>
        </div>
        <div class="info-field">
            <span class="info-label">Code</span>
            <span class="info-value">{{ model.code }}</span>
        </div>
        <div class="info-field">
            <span class="info-label">Real Name</span>
            <span class="info-value">{{ model.real_name }}</span>
        </div>
        <div class="info-field">
            <span class="info-label">Working Name</span>
            <span class="info-value">{{ model.working_name }}</span>
        </div>
        <div class="info-field">
            <span class="info-label">Start Date</span>
            <span class="info-value">{{ model.start_date.strftime('%m/%d/%Y') if model.start_date else '—' }}</span>
        </div>
        <div class="info-field">
            <span class="info-label">Payment Method</span>
            <span class="info-value">{{ model.payment_method }}</span>
        </div>
        <div class="info-field">
            <span class="info-label">Payment Frequency</span>
            <span class="info-value">{{ model.payment_frequency|title }}</span>
        </div>
        <div class="info-field">
            <span class="info-label">Monthly Amount (USD)</span>
            <span class="info-value">${{ '%.2f'|format(model.amount_monthly) }}</span>
        </div>
        <div class="info-field span-all">
            <span class="info-label">Crypto Wallet Address</span>
            <span class="info-value {{ 'info-value--muted' if not model.crypto_wallet }}">{{ model.crypto_wallet if model.crypto_wallet else 'Not provided' }}</span>
        </div>
    </div>
</section>

{% set adjustments = model.compensation_adjustments or [] %}
{% set adjustments_count = adjustments|length %}
{% set latest_adjustment = adjustments[-1] if adjustments_count else None %}

<section class="card card--form">
    <header class="card-heading">
        <h2>Compensation Timeline</h2>
    </header>
    <details class="adjustments-panel" {% if adjustments_count %}open{% endif %}>
        <summary class="adjustments-summary">
            <span class="adjustments-summary-title">Scheduled Adjustments</span>
            <span class="adjustments-summary-meta">
                <span class="adjustments-chip">
                    {% if adjustments_count %}
                        {{ adjustments_count }} scheduled
                    {% else %}
                        None scheduled
                    {% endif %}
                </span>
                <span class="adjustments-summary-text">
                    {% if adjustments_count and latest_adjustment %}
                        Latest {{ latest_adjustment.effective_date.strftime('%b %d, %Y') }} · ${{ '%.2f'|format(latest_adjustment.amount_monthly) }}
                    {% endif %}
                </span>
            </span>
        </summary>
        <div class="adjustments-body">
            {% if adjustments_count %}
            <div class="data-table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Effective Date</th>
                            <th>Monthly Amount</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for adjustment in adjustments %}
                        <tr>
                            <td>{{ adjustment.effective_date.strftime('%m/%d/%Y') }}</td>
                            <td class="info-value">${{ '%.2f'|format(adjustment.amount_monthly) }}</td>
                            <td class="info-value--muted">{{ adjustment.notes or '—' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="form-hint">No adjustment history captured yet. Add raises on the model edit screen.</p>
            {% endif %}
        </div>
    </details>
</section>

<section class="card card--form">
    <header class="card-heading">
        <h2>Payment Summary</h2>
    </header>
    <div class="info-grid two-column">
        <div class="info-field">
            <span class="info-label">Total Paid (USD)</span>
            <span class="info-value">${{ '%.2f'|format(total_paid) }}</span>
        </div>
        <div class="info-field">
            <span class="info-label">Created</span>
            <span class="info-value">{{ model.created_at.strftime('%m/%d/%Y %I:%M %p') if model.created_at else '—' }}</span>
        </div>
    </div>
</section>

<section class="card card--form">
    {% set adhoc_count = adhoc_payments|length %}
    {% set pending_count = adhoc_payments | selectattr('status', 'equalto', 'pending') | list | length %}
    {% set latest_payment = adhoc_payments[0] if adhoc_count else None %}

    <details class="adjustments-panel" {% if adhoc_count %}open{% endif %}>
        <summary class="adjustments-summary">
            <span class="adjustments-summary-title">Ad Hoc Payments</span>
            <span class="adjustments-summary-meta">
                <span class="adjustments-chip">
                    {% if adhoc_count %}
                        {{ adhoc_count }} recorded
                    {% else %}
                        None recorded
                    {% endif %}
                </span>
                <span class="adjustments-summary-text">
                    {% if pending_count %}
                        {{ pending_count }} pending
                    {% elif latest_payment %}
                        Latest {{ latest_payment.pay_date.strftime('%b %d, %Y') }} · ${{ '%.2f'|format(latest_payment.amount) }}
                    {% endif %}
                </span>
            </span>
        </summary>
        <div class="adjustments-body">
            <p class="form-hint">Log one-off payments that fall outside scheduled payroll runs.</p>

            {% if user.role == 'admin' %}
            <form action="/models/{{ model.id }}/adhoc-payments" method="post" class="adhoc-form">
                <div class="adhoc-form__panel">
                    <div class="adhoc-form__header">
                        <div>
                            <h3 class="adhoc-form__title">Record New Payment</h3>
                            <p class="adhoc-form__subtitle">Capture the payment details that should appear on the ledger.</p>
                        </div>
                        <div class="adhoc-form__stats">
                            <span class="adhoc-chip">Pending: {{ pending_count }}</span>
                            <span class="adhoc-chip adhoc-chip--highlight">Total Recorded: {{ adhoc_count }}</span>
                        </div>
                    </div>
                    <div class="form-grid two-column">
                        <div class="form-row">
                            <label for="adhoc-pay-date">Pay Date <span class="required-badge">Required</span></label>
                            <input id="adhoc-pay-date" name="pay_date" type="date" required />
                        </div>
                        <div class="form-row">
                            <label for="adhoc-amount">Amount (USD) <span class="required-badge">Required</span></label>
                            <input id="adhoc-amount" name="amount" type="number" step="0.01" min="0.01" required />
                        </div>
                        <div class="form-row">
                            <label for="adhoc-description">Description</label>
                            <input id="adhoc-description" name="description" type="text" maxlength="255" placeholder="Reason or memo" />
                        </div>
                        <div class="form-row span-all">
                            <label for="adhoc-notes">Notes (internal)</label>
                            <textarea id="adhoc-notes" name="notes" rows="3" placeholder="Optional notes for this payment"></textarea>
                        </div>
                    </div>
                </div>
                <div class="adhoc-form__actions">
                    <button class="button" type="submit">Add Ad Hoc Payment</button>
                    <p class="form-hint">Saved instantly — this entry will sync with the payments table below.</p>
                </div>
            </form>
            {% endif %}

            {% if adhoc_payments %}
            <div class="data-table-wrapper adhoc-table">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Pay Date</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Description</th>
                            <th>Notes</th>
                            {% if user.role == 'admin' %}
                            <th>Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for payment in adhoc_payments %}
                        <tr>
                            <td>{{ payment.pay_date.strftime('%m/%d/%Y') }}</td>
                            <td class="info-value">${{ '%.2f'|format(payment.amount) }}</td>
                            <td>
                                {% if payment.status == 'paid' %}
                                    <span class="status-chip status-chip--active">Paid</span>
                                {% elif payment.status == 'cancelled' %}
                                    <span class="status-chip status-chip--neutral">Cancelled</span>
                                {% else %}
                                    <span class="status-chip status-chip--warning">Pending</span>
                                {% endif %}
                            </td>
                            <td class="info-value--muted">{{ payment.description or '—' }}</td>
                            <td>
                                <div class="info-value--muted">{{ payment.notes or '—' }}</div>
                                {% if user.role == 'admin' %}
                                <details class="notes-editor">
                                    <summary>Edit notes</summary>
                                    <form action="/models/{{ model.id }}/adhoc-payments/{{ payment.id }}/notes" method="post">
                                        <textarea name="notes" rows="2" placeholder="Update notes">{{ payment.notes or '' }}</textarea>
                                        <button class="link-button" type="submit">Save</button>
                                    </form>
                                </details>
                                {% endif %}
                            </td>
                            {% if user.role == 'admin' %}
                            <td class="actions actions--compact">
                                <form action="/models/{{ model.id }}/adhoc-payments/{{ payment.id }}/status" method="post">
                                    <input name="action" type="hidden" value="mark_paid" />
                                    <button class="link-button" type="submit" {% if payment.status == 'paid' %}disabled{% endif %}>Mark Paid</button>
                                </form>
                                <form action="/models/{{ model.id }}/adhoc-payments/{{ payment.id }}/status" method="post">
                                    <input name="action" type="hidden" value="mark_pending" />
                                    <button class="link-button" type="submit" {% if payment.status == 'pending' %}disabled{% endif %}>Set Pending</button>
                                </form>
                                <form action="/models/{{ model.id }}/adhoc-payments/{{ payment.id }}/status" method="post">
                                    <input name="action" type="hidden" value="cancel" />
                                    <button class="link-button" type="submit" {% if payment.status == 'cancelled' %}disabled{% endif %}>Cancel</button>
                                </form>
                                <form action="/models/{{ model.id }}/adhoc-payments/{{ payment.id }}/delete" method="post" onsubmit="return confirm('Delete this ad hoc payment?');">
                                    <button class="link-button" type="submit">Delete</button>
                                </form>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state" style="margin-top: 16px;">
                No ad hoc payments recorded for this model yet.
            </div>
            {% endif %}
        </div>
    </details>
</section>

<section class="card card--form">
    <div class="card-actions card-actions--end card-actions--stack">
        {% if user.role == 'admin' %}
        <a class="button" href="/models/{{ model.id }}/edit">Edit Model</a>
        <button class="button secondary" type="button" onclick="if(confirm('Delete this model?')) { fetch('/models/{{ model.id }}/delete', { method: 'POST' }).then(() => window.location.href='/models'); }">Delete Model</button>
        {% endif %}
        <a class="button secondary" href="/models">Back to Roster</a>
    </div>
</section>

<section class="card card--form table-card">
    <header class="card-heading">
        <h2>Payment History</h2>
        <p>Payment records from scheduled payroll runs</p>
    </header>
    {% if paid_payouts %}
    <div class="data-table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Pay Date</th>
                    <th>Code</th>
                    <th>Working Name</th>
                    <th>Method</th>
                    <th>Frequency</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>
                {% for payout in paid_payouts %}
                <tr>
                    <td>{{ payout.pay_date.strftime('%m/%d/%Y') }}</td>
                    <td style="font-weight: 600;">{{ payout.code }}</td>
                    <td>{{ payout.working_name }}</td>
                    <td>{{ payout.payment_method }}</td>
                    <td>{{ payout.payment_frequency|title }}</td>
                    <td class="info-value">${{ '%.2f'|format(payout.amount) }}</td>
                    <td>
                        {% if payout.status == 'paid' %}
                            <span class="status-chip status-chip--active">Paid</span>
                        {% elif payout.status == 'on_hold' %}
                            <span class="status-chip status-chip--warning">On Hold</span>
                        {% else %}
                            <span class="status-chip status-chip--neutral">Not Paid</span>
                        {% endif %}
                    </td>
                    <td class="info-value--muted">{{ payout.notes or '—' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        No paid payments recorded yet. View <a href="/schedules">Schedule Runs</a> to manage payments.
    </div>
    {% endif %}
</section>
{% endblock %}
