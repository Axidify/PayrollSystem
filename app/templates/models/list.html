{% extends "base.html" %}
{% block title %}Models Â· Payroll Desk{% endblock %}
{% block content %}
<section class="page-header">
    <div>
        <h1 class="page-title">Model Roster</h1>
        <p>Maintain active talent, salaries, and payment preferences.</p>
    </div>
    <div class="header-actions">
        <a class="button secondary" href="/models/snapshot">Open Snapshot</a>
        {% if user.role == 'admin' %}
        <button class="button secondary" type="button" onclick="openImportModal()">Import Excel</button>
        <a class="button" href="/models/new">Add Model</a>
        {% endif %}
    </div>
</section>

{% if import_error %}
<div class="alert error">
    <strong>Import failed.</strong> {{ import_error }}
</div>
{% elif import_summary %}
    {% set skipped_rows = (import_summary.model_errors + import_summary.payout_errors) %}
<div class="alert success">
    <strong>Import complete.</strong>
    Added {{ import_summary.models_created }} model(s), updated {{ import_summary.models_updated }},
    and created {{ import_summary.payouts_created }} payout(s)
    {% if import_summary.schedule_run_ids and import_summary.schedule_run_ids|length > 1 %}
        across schedule runs
        <span>
            {% for run_id in import_summary.schedule_run_ids %}
                #{{ run_id }}{% if not loop.last %}, {% endif %}
            {% endfor %}
        </span>.
    {% elif import_summary.schedule_run_id %}
        in schedule run #{{ import_summary.schedule_run_id }}.
    {% else %}
        but no schedule run was created.
    {% endif %}
    {% if skipped_rows %}
    <details>
        <summary>View skipped rows</summary>
        <ul>
            {% for message in skipped_rows %}
            <li>{{ message }}</li>
            {% endfor %}
        </ul>
    </details>
    {% endif %}
</div>
{% endif %}

<section class="card-grid columns-3">
    <div class="card metric">
        <div class="metric-title">Total Models</div>
        <div class="metric-value">{{ models|length }}</div>
    </div>
    <div class="card metric">
        <div class="metric-title">Active</div>
        <div class="metric-value">{{ models|selectattr('status', 'equalto', 'Active')|list|length }}</div>
    </div>
    <div class="card metric">
        <div class="metric-title">Inactive</div>
        <div class="metric-value">{{ models|selectattr('status', 'equalto', 'Inactive')|list|length }}</div>
    </div>
    <div class="card metric">
        <div class="metric-title">Lifetime Paid (USD)</div>
    <div class="metric-value">${{ total_paid_sum|money }}</div>
    </div>
</section>

<section class="card" style="margin-top: 24px;">
    <form class="filter-bar" method="get">
        <div class="filter-group">
            <label for="code">Code</label>
            <input id="code" name="code" type="text" placeholder="Search code" value="{{ filters.code }}" list="model-code-options" autocomplete="off" />
            <datalist id="model-code-options">
                {% for model in models %}
                    {% if model.code %}
                    <option value="{{ model.code }}"></option>
                    {% endif %}
                {% endfor %}
            </datalist>
        </div>
        <div class="filter-group">
            <label for="status">Status</label>
            <select id="status" name="status">
                <option value="">All</option>
                {% for option in status_options %}
                    <option value="{{ option }}" {% if filters.status == option %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="frequency">Frequency</label>
            <select id="frequency" name="frequency">
                <option value="">All</option>
                {% for option in frequency_options %}
                    <option value="{{ option }}" {% if filters.frequency == option %}selected{% endif %}>{{ option|title }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="payment_method">Payment Method</label>
            <select id="payment_method" name="payment_method">
                <option value="">All</option>
                {% for method in payment_methods %}
                    <option value="{{ method }}" {% if filters.payment_method == method %}selected{% endif %}>{{ method }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-actions">
            <button class="button" type="submit">Apply</button>
            <a class="button secondary" href="/models">Reset</a>
        </div>
    </form>
</section>

<section class="card" style="margin-top: 24px;">
    <h2>Roster Details</h2>
    <table class="data-table">
        <thead>
            <tr>
                <th>Code</th>
                <th>Status</th>
                <th>Real Name</th>
                <th>Working Name</th>
                <th>Start Date</th>
                <th>Frequency</th>
                <th>Monthly Salary (USD)</th>
                <th>Payment Method</th>
                <th>Total Paid (USD)</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for model in models %}
            <tr>
                <td>{{ model.code }}</td>
                <td>
                    {% if model.status == 'Active' %}
                        <span class="tag active">Active</span>
                    {% else %}
                        <span class="tag inactive">Inactive</span>
                    {% endif %}
                </td>
                <td>{{ model.real_name }}</td>
                <td>{{ model.working_name }}</td>
                <td>{{ model.start_date|display_date }}</td>
                <td>{{ model.payment_frequency|title }}</td>
                <td>${{ model.amount_monthly|money }}</td>
                <td>{{ model.payment_method }}</td>
                {% set lifetime = totals_map.get(model.id, 0) %}
                <td>${{ lifetime|money }}</td>
                <td class="actions">
                    <a class="link-button" href="/models/{{ model.id }}">View</a>
                    {% if user.role == 'admin' %}
                    <a class="link-button" href="/models/{{ model.id }}/edit">Edit</a>
                    <form action="/models/{{ model.id }}/delete" method="post" onsubmit="return confirm('Delete this model?');">
                        <button class="link-button" type="submit">Delete</button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td class="empty-state" colspan="10">No models captured yet. Add one to get started.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>

{% if user.role == 'admin' %}
<div class="modal-overlay" id="importModalOverlay"></div>
<div class="modal" id="importModal" role="dialog" aria-modal="true" aria-labelledby="importModalTitle">
    <div class="modal-header">
        <h2 id="importModalTitle">Import Models From Excel</h2>
    <button class="link-button" type="button" aria-label="Close import dialog" onclick="closeImportModal()">X</button>
    </div>
    <p style="margin-top: 0;">
        Upload the workbook with <strong>Models</strong> and <strong>Payouts</strong> sheets to seed the roster and schedule.
        <a href="/static/import_templates/payroll_import_template.xlsx" download>Download the template</a> if you need a fresh copy.
    </p>
    <form action="/models/import" method="post" enctype="multipart/form-data" class="form" style="margin-top: 16px;">
        <div class="form-row">
            <label for="excel_file">Excel workbook (.xlsx)</label>
            <input id="excel_file" name="excel_file" type="file" accept=".xlsx,.xlsm,.xls" required />
        </div>
        <div class="checkbox-row">
            <input id="auto_runs" name="auto_runs" type="checkbox" {% if import_auto_runs %}checked{% endif %} onchange="toggleAutoRuns(this.checked)" />
            <label for="auto_runs">Auto-create payroll runs from payout months</label>
        </div>
        <div class="form-row">
            <label for="currency">Currency</label>
            <input id="currency" name="currency" type="text" value="USD" />
        </div>
        <div class="checkbox-row">
            <input id="update_existing" name="update_existing" type="checkbox" {% if import_update_existing %}checked{% endif %} />
            <label for="update_existing">Update existing models when codes already exist</label>
        </div>
        <div class="modal-actions">
            <button class="button" type="submit">Import Data</button>
            <button class="button secondary" type="button" onclick="closeImportModal()">Cancel</button>
        </div>
    </form>
</div>

<script>
function openImportModal() {
    const overlay = document.getElementById('importModalOverlay');
    const modal = document.getElementById('importModal');
    if (!modal || !overlay) {
        return;
    }
    overlay.classList.add('active');
    modal.classList.add('active');
}

function closeImportModal() {
    const overlay = document.getElementById('importModalOverlay');
    const modal = document.getElementById('importModal');
    if (!modal || !overlay) {
        return;
    }
    overlay.classList.remove('active');
    modal.classList.remove('active');
}

function toggleAutoRuns() {
    // Auto-run checkbox remains for future enhancements; no additional fields to toggle.
}

const importOverlay = document.getElementById('importModalOverlay');
if (importOverlay) {
    importOverlay.addEventListener('click', closeImportModal);
}

document.addEventListener('DOMContentLoaded', function () {
    const autoRunsCheckbox = document.getElementById('auto_runs');
    if (autoRunsCheckbox) {
        toggleAutoRuns(autoRunsCheckbox.checked);
    }
});
</script>
{% endif %}
{% endblock %}
