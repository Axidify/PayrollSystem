{% extends "base.html" %}
{% block title %}Schedules · Payroll Desk{% endblock %}

{% macro render_run_card(run, allow_delete=False, user_role='') %}
<article class="run-card">
    <div class="run-card__header">
        <div class="run-card__titles">
            <span class="run-card__cycle">{{ run.cycle }}</span>
            <span class="run-card__meta">Created {{ run.created }}</span>
        </div>
        <span class="status-chip status-chip--{{ run.status_variant|default('neutral') }}">{{ run.status }}</span>
    </div>
    <div class="run-card__metrics">
        <div>
            <span class="run-card__metric-label">Total</span>
            <span class="run-card__metric-value">{{ run.currency or 'USD' }} {{ run.total|money }}</span>
        </div>
        <div>
            <span class="run-card__metric-label">Paid</span>
            <span class="run-card__metric-value">{{ run.currency or 'USD' }} {{ run.paid|money }}</span>
        </div>
        {% set outstanding_value = run.outstanding or 0 %}
        <div>
            <span class="run-card__metric-label">Outstanding</span>
            <span class="run-card__metric-value{% if outstanding_value > 0 %} is-warning{% endif %}">{{ run.currency or 'USD' }} {{ outstanding_value|money }}</span>
        </div>
        <div>
            <span class="run-card__metric-label">Models Paid</span>
            <span class="run-card__metric-value">{{ run.models_paid or 0 }}</span>
        </div>
    </div>
    <div class="run-card__frequencies">
        {% if run.frequency_counts %}
            {% for name, count in run.frequency_counts|dictsort %}
            <span class="frequency-chip">{{ name|replace('_', ' ')|title }} · {{ count }}</span>
            {% endfor %}
        {% else %}
        <span class="run-card__empty">No payout cadence recorded.</span>
        {% endif %}
    </div>
    <div class="run-card__actions">
        <a class="run-card__action-button run-card__action-button--open" href="/schedules/{{ run.id }}">Open</a>
        {% if allow_delete and user_role == 'admin' %}
        <form method="post" action="/schedules/{{ run.id }}/delete" onsubmit="return confirm('Delete this payroll run?');">
            <button class="run-card__action-button run-card__action-button--delete" type="submit">Delete</button>
        </form>
        {% endif %}
    </div>
</article>
{% endmacro %}

{% block content %}
<section class="page-header">
    <div>
        <h1 class="page-title">Payroll Runs</h1>
        <p>Track cycles, payouts, and outstanding actions at a glance.</p>
    </div>
    <div class="header-actions">
        <a class="button secondary" href="{{ view_all_url }}">View All Runs</a>
        <a class="button secondary" href="{{ table_view_url }}">Table View</a>
        <button class="button secondary" type="button" onclick="openExportModal()">Export Excel</button>
        {% if user.role == 'admin' %}
        <a class="button" href="/schedules/new">Run Payroll</a>
        {% endif %}
    </div>
</section>

{% if has_runs %}
<section class="card calendar-card">
    <div class="section-heading">
        <div>
            <h2>Year At A Glance</h2>
            <p>Select a month to focus the totals below.</p>
        </div>
        <div class="heading-actions">
            <a class="button secondary" href="/schedules">Latest Month</a>
        </div>
    </div>
    <div class="calendar-strip">
        {% for slot in year_overview %}
        <a class="calendar-chip{% if slot.value == filters.month %} is-active{% elif slot.is_current and not filters.month %} is-current{% endif %}{% if not slot.has_runs %} is-empty{% endif %}"
           href="?month={{ slot.value }}"
           aria-label="View runs for {{ slot.label }}">
            <span class="calendar-chip__label">{{ slot.label }}</span>
            {% if slot.count %}
            <span class="calendar-chip__count">{{ slot.count }}</span>
            {% endif %}
        </a>
        {% endfor %}
    </div>
</section>

<section class="stat-grid">
    <article class="card stat-card">
        <p class="stat-card__label">Runs Tracked</p>
        <p class="stat-card__value">{{ monthly_summary.run_count }}</p>
        <p class="stat-card__hint">{{ selected_month_label or 'Latest cycle' }}</p>
    </article>
    <article class="card stat-card">
        <p class="stat-card__label">Total Payout</p>
    <p class="stat-card__value">{{ monthly_summary.currency or 'USD' }} {{ monthly_summary.total_payout|money }}</p>
        <p class="stat-card__hint">All runs in view</p>
    </article>
    <article class="card stat-card">
        <p class="stat-card__label">Paid</p>
    <p class="stat-card__value">{{ monthly_summary.currency or 'USD' }} {{ monthly_summary.paid_total|money }}</p>
        <p class="stat-card__hint">Cleared payouts</p>
    </article>
    <article class="card stat-card">
        <p class="stat-card__label">Outstanding</p>
    <p class="stat-card__value{% if monthly_summary.unpaid_total > 0 %} is-warning{% endif %}">{{ monthly_summary.currency or 'USD' }} {{ monthly_summary.unpaid_total|money }}</p>
        <p class="stat-card__hint">Pending to pay</p>
    </article>
    <article class="card stat-card">
        <p class="stat-card__label">Models Paid</p>
        <p class="stat-card__value">{{ monthly_summary.models_paid }}</p>
        <p class="stat-card__hint">Across visible runs</p>
    </article>
    <article class="card stat-card">
        <p class="stat-card__label">Ad Hoc ({{ monthly_adhoc_summary.month_label }})</p>
    <p class="stat-card__value">{{ monthly_adhoc_summary.currency }} {{ monthly_adhoc_summary.total_amount|money }}</p>
        <p class="stat-card__hint">{{ monthly_adhoc_summary.count }} payment{% if monthly_adhoc_summary.count != 1 %}s{% endif %} · {{ monthly_adhoc_summary.status_counts.pending }} pending</p>
    </article>
</section>

<div class="highlight-grid">
    <section class="card highlight-card">
        <div class="section-heading">
            <div>
                <h2>{{ selected_month_label or 'Latest Cycle' }}</h2>
                <p>{{ monthly_summary.run_count }} run{% if monthly_summary.run_count != 1 %}s{% endif %} captured for this period.</p>
            </div>
        </div>
        {% if selected_run_cards %}
        <div class="run-grid">
            {% for run in selected_run_cards %}
            {{ render_run_card(run, True, user.role) }}
            {% endfor %}
        </div>
        {% else %}
        <p class="empty-state">No payroll runs recorded for {{ selected_month_label or 'this period' }}.</p>
        {% endif %}
    </section>
    {% if monthly_adhoc_summary.has_payments %}
    <section class="card highlight-card adhoc-highlight">
        <div class="section-heading">
            <div>
                <h2>Ad Hoc Payments</h2>
                <p>{{ monthly_adhoc_summary.count }} recorded for {{ monthly_adhoc_summary.month_label }} · latest {{ monthly_adhoc_summary.latest_pay_date_display or 'n/a' }}</p>
            </div>
        </div>
        <div class="adhoc-highlight__status-grid">
            {% for item in monthly_adhoc_summary.status_display %}
            <div class="adhoc-highlight__status-card adhoc-highlight__status-card--{{ item.key }}">
                <span class="adhoc-highlight__status-label">{{ item.label }}</span>
                <span class="adhoc-highlight__status-count">{{ item.count }} payment{% if item.count != 1 %}s{% endif %}</span>
                <span class="adhoc-highlight__status-amount">{{ monthly_adhoc_summary.currency }} {{ item.amount|money }}</span>
            </div>
            {% endfor %}
        </div>
        <div class="adhoc-highlight__totals">
            <div>
                <span class="adhoc-highlight__label">Total Recorded</span>
                <span class="adhoc-highlight__value">{{ monthly_adhoc_summary.currency }} {{ monthly_adhoc_summary.total_amount|money }}</span>
            </div>
            <div>
                <span class="adhoc-highlight__label">Pending</span>
                <span class="adhoc-highlight__value">{{ monthly_adhoc_summary.currency }} {{ monthly_adhoc_summary.pending_total|money }}</span>
            </div>
            <div>
                <span class="adhoc-highlight__label">Paid</span>
                <span class="adhoc-highlight__value">{{ monthly_adhoc_summary.currency }} {{ monthly_adhoc_summary.paid_total|money }}</span>
            </div>
            <div>
                <span class="adhoc-highlight__label">Cancelled</span>
                <span class="adhoc-highlight__value">{{ monthly_adhoc_summary.currency }} {{ monthly_adhoc_summary.cancelled_total|money }}</span>
            </div>
        </div>
    </section>
    {% endif %}
</div>

{% if monthly_adhoc_summary.has_payments %}
<section class="card card--adhoc-table">
    <div class="section-heading">
        <div>
            <h2>Ad Hoc Payments — {{ monthly_adhoc_summary.month_label }}</h2>
            <p>{{ monthly_adhoc_summary.count }} payment{% if monthly_adhoc_summary.count != 1 %}s{% endif %} impacting {{ monthly_adhoc_summary.models_impacted }} model{% if monthly_adhoc_summary.models_impacted != 1 %}s{% endif %}.</p>
        </div>
    </div>
    {% set table_return_url = '/schedules' %}
    {% if filters.month %}
        {% set table_return_url = table_return_url + '?month=' + filters.month %}
    {% endif %}
    <div class="data-table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Model</th>
                    <th>Pay Date</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Description</th>
                    <th>Notes</th>
                    {% if user.role == 'admin' %}
                    <th class="adhoc-table__status-column">Update Status</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for payment in monthly_adhoc_payments %}
                <tr>
                    <td>
                        <div class="adhoc-table__model">{{ payment.model.working_name or payment.model.code }}</div>
                        <div class="adhoc-table__code">{{ payment.model.code }}</div>
                    </td>
                    <td>{{ payment.pay_date.strftime('%m/%d/%Y') }}</td>
                    <td class="info-value">{{ monthly_adhoc_summary.currency }} {{ payment.amount|money }}</td>
                    <td>
                        {% if payment.status == 'paid' %}
                        <span class="status-chip status-chip--active">Paid</span>
                        {% elif payment.status == 'pending' %}
                        <span class="status-chip status-chip--warning">Pending</span>
                        {% else %}
                        <span class="status-chip status-chip--neutral">Cancelled</span>
                        {% endif %}
                    </td>
                    <td class="info-value--muted">{{ payment.description or '—' }}</td>
                    <td class="info-value--muted">{{ payment.notes or '—' }}</td>
                    {% if user.role == 'admin' %}
                    <td class="adhoc-table__status-cell">
                        <form class="adhoc-status-form" action="/models/{{ payment.model_id }}/adhoc-payments/{{ payment.id }}/status" method="post">
                            <input name="return_url" type="hidden" value="{{ table_return_url }}" />
                            <label class="sr-only" for="status_select_{{ payment.id }}">Update status for {{ payment.model.working_name or payment.model.code }}</label>
                            <select class="adhoc-status-select" id="status_select_{{ payment.id }}" name="action">
                                <option value="mark_pending" {% if payment.status == 'pending' %}selected{% endif %}>Pending</option>
                                <option value="mark_paid" {% if payment.status == 'paid' %}selected{% endif %}>Paid</option>
                                <option value="cancel" {% if payment.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                            </select>
                            <noscript>
                                <button class="button secondary" type="submit">Apply</button>
                            </noscript>
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% else %}
<section class="card card--adhoc-table">
    <div class="section-heading">
        <div>
            <h2>Ad Hoc Payments — {{ monthly_adhoc_summary.month_label }}</h2>
            <p>No ad hoc payments logged for this month.</p>
        </div>
    </div>
</section>
{% endif %}

<section class="card">
    <div class="section-heading">
        <div>
            <h2>Recent Activity</h2>
            <p>The latest completed payroll runs.</p>
        </div>
    </div>
    {% if recent_runs %}
    <div class="run-grid">
        {% for run in recent_runs %}
        {{ render_run_card(run, False, user.role) }}
        {% endfor %}
    </div>
    {% else %}
    <p class="empty-state">No historical runs yet. Once you record payroll this view will populate.</p>
    {% endif %}
</section>
{% else %}
<section class="card">
    <h2>No payroll runs yet</h2>
    <p class="empty-state" style="margin: 0;">Run your first payroll to populate this view.</p>
    {% if user.role == 'admin' %}
    <a class="button" href="/schedules/new" style="margin-top: 16px; display: inline-block;">Run Payroll</a>
    {% endif %}
</section>
{% endif %}

<div class="modal-overlay" id="exportModalOverlay"></div>
<div class="modal" id="exportModal" role="dialog" aria-modal="true" aria-labelledby="exportModalTitle">
    <div class="modal-header">
        <h2 id="exportModalTitle">Export Dashboard Data</h2>
        <button class="link-button" type="button" aria-label="Close export dialog" onclick="closeExportModal()">X</button>
    </div>
    <p style="margin-top: 0;">
        Choose the datasets to include in your Excel workbook. Selections apply to the currently viewed month.
    </p>
    <form id="exportExcelForm" action="/schedules/export" method="post" class="form" style="margin-top: 16px;">
        <input name="month" type="hidden" value="{{ export_month_value }}" />
        <div class="checkbox-row">
            <input id="export_monthly_summary" name="include_monthly_summary" type="checkbox" value="1" {% if export_defaults.monthly_summary %}checked{% endif %} />
            <label for="export_monthly_summary">Monthly summary metrics</label>
        </div>
        <div class="checkbox-row">
            <input id="export_run_details" name="include_run_details" type="checkbox" value="1" {% if export_defaults.run_details %}checked{% endif %} />
            <label for="export_run_details">Run breakdown for selected month</label>
        </div>
        <div class="checkbox-row">
            <input id="export_adhoc_summary" name="include_adhoc_summary" type="checkbox" value="1" {% if export_defaults.adhoc_summary %}checked{% endif %} />
            <label for="export_adhoc_summary">Ad hoc payment summary</label>
        </div>
        <div class="checkbox-row">
            <input id="export_adhoc_details" name="include_adhoc_details" type="checkbox" value="1" {% if export_defaults.adhoc_details %}checked{% endif %} />
            <label for="export_adhoc_details">Ad hoc payment details</label>
        </div>
        <div class="checkbox-row">
            <input id="export_recent_runs" name="include_recent_runs" type="checkbox" value="1" {% if export_defaults.recent_runs %}checked{% endif %} />
            <label for="export_recent_runs">Recent run snapshots</label>
        </div>
        <div class="modal-actions">
            <button class="button" type="submit">Export</button>
            <button class="button secondary" type="button" onclick="closeExportModal()">Cancel</button>
        </div>
    </form>
</div>

<script>
function openExportModal() {
    const overlay = document.getElementById('exportModalOverlay');
    const modal = document.getElementById('exportModal');
    if (!modal || !overlay) {
        return;
    }
    overlay.classList.add('active');
    modal.classList.add('active');
}

function closeExportModal() {
    const overlay = document.getElementById('exportModalOverlay');
    const modal = document.getElementById('exportModal');
    if (!modal || !overlay) {
        return;
    }
    overlay.classList.remove('active');
    modal.classList.remove('active');
}

function validateExportSelection(event) {
    const form = event.target;
    const checkboxes = form.querySelectorAll('input[type="checkbox"]');
    const hasSelection = Array.from(checkboxes).some((checkbox) => checkbox.checked);
    if (!hasSelection) {
        event.preventDefault();
        alert('Select at least one dataset to export.');
    }
}

const exportOverlay = document.getElementById('exportModalOverlay');
if (exportOverlay) {
    exportOverlay.addEventListener('click', closeExportModal);
}

document.addEventListener('DOMContentLoaded', function () {
    const exportForm = document.getElementById('exportExcelForm');
    if (exportForm) {
        exportForm.addEventListener('submit', validateExportSelection);
    }

    const statusSelects = document.querySelectorAll('.adhoc-status-select');
    statusSelects.forEach(function (select) {
        select.addEventListener('change', function () {
            const parentForm = select.closest('form');
            if (parentForm) {
                parentForm.submit();
            }
        });
    });
});
</script>
{% endblock %}
