{% extends "base.html" %}
{% block title %}{{ 'Edit Model' if action == 'edit' else 'Add Model' }} Â· Payroll Desk{% endblock %}
{% block content %}
<section class="page-header">
    <div>
        <h1 class="page-title">{{ 'Edit Model' if action == 'edit' else 'Add Model' }}</h1>
        <p>Capture roster information used for automated payroll scheduling.</p>
    </div>
</section>

<section class="card" style="max-width: 820px;">
    <form class="form" method="post">
        <div class="form-row">
            <label for="status">Status</label>
            <select id="status" name="status" required>
                {% set status_value = model.status if model else 'Active' %}
                <option value="Active" {% if status_value == 'Active' %}selected{% endif %}>Active</option>
                <option value="Inactive" {% if status_value == 'Inactive' %}selected{% endif %}>Inactive</option>
            </select>
        </div>
        <div class="form-row">
            <label for="code">Code</label>
            <input id="code" name="code" type="text" required value="{{ model.code if model else '' }}" />
        </div>
        <div class="form-row">
            <label for="real_name">Real Name</label>
            <input id="real_name" name="real_name" type="text" required value="{{ model.real_name if model else '' }}" />
        </div>
        <div class="form-row">
            <label for="working_name">Working Name</label>
            <input id="working_name" name="working_name" type="text" required value="{{ model.working_name if model else '' }}" />
        </div>
        <div class="form-row">
            <label for="start_date">Start Date</label>
            <input id="start_date" name="start_date" type="date" required value="{{ model.start_date if model else '' }}" />
        </div>
        <div class="form-row">
            <label for="payment_method">Payment Method</label>
            <input id="payment_method" name="payment_method" type="text" required value="{{ model.payment_method if model else '' }}" />
        </div>
        <div class="form-row">
            <label for="payment_frequency">Frequency</label>
            {% set freq_value = model.payment_frequency if model else 'weekly' %}
            <select id="payment_frequency" name="payment_frequency" required>
                <option value="weekly" {% if freq_value == 'weekly' %}selected{% endif %}>Weekly</option>
                <option value="biweekly" {% if freq_value == 'biweekly' %}selected{% endif %}>Biweekly</option>
                <option value="monthly" {% if freq_value == 'monthly' %}selected{% endif %}>Monthly</option>
            </select>
        </div>
        <div class="form-row">
            <label for="amount_monthly">Monthly Amount (USD)</label>
            <input id="amount_monthly" name="amount_monthly" type="number" step="0.01" min="0" required value="{{ '%.2f'|format(model.amount_monthly) if model else '' }}" />
        </div>
        <div class="form-row">
            <label>Compensation Adjustments</label>
            {% set adjustments = model.compensation_adjustments if model and model.compensation_adjustments else [] %}
            <div class="adjustments-list" data-adjustments>
                {% if adjustments %}
                    {% for adjustment in adjustments %}
                    <div class="adjustment-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: end;">
                        <div>
                            <div style="font-size: 0.8rem; font-weight: 600; margin-bottom: 4px;">Effective Date</div>
                            <input name="adjustment_effective_dates" type="date" required value="{{ adjustment.effective_date.strftime('%Y-%m-%d') }}" />
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; font-weight: 600; margin-bottom: 4px;">Monthly Amount</div>
                            <input name="adjustment_amounts" type="number" step="0.01" min="0.01" required value="{{ '%.2f'|format(adjustment.amount_monthly) }}" />
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; font-weight: 600; margin-bottom: 4px;">Notes (Optional)</div>
                            <input name="adjustment_notes" type="text" value="{{ adjustment.notes or '' }}" />
                        </div>
                        <button type="button" class="button tertiary" data-remove-adjustment>Remove</button>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="adjustment-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: end;">
                        <div>
                            <div style="font-size: 0.8rem; font-weight: 600; margin-bottom: 4px;">Effective Date</div>
                            <input name="adjustment_effective_dates" type="date" />
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; font-weight: 600; margin-bottom: 4px;">Monthly Amount</div>
                            <input name="adjustment_amounts" type="number" step="0.01" min="0.01" />
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; font-weight: 600; margin-bottom: 4px;">Notes (Optional)</div>
                            <input name="adjustment_notes" type="text" />
                        </div>
                        <button type="button" class="button tertiary" data-remove-adjustment>Remove</button>
                    </div>
                {% endif %}
            </div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <button type="button" class="button secondary" id="add-adjustment">Add Adjustment</button>
                <p style="margin: 0; font-size: 0.85rem; color: #cbd5e1;">(Optional) Add raises that take effect after the model start date. Rows without a date and amount are ignored.</p>
            </div>
        </div>
        <div class="form-row">
            <label for="crypto_wallet">Crypto Wallet Address (Optional)</label>
            <input id="crypto_wallet" name="crypto_wallet" type="text" value="{{ model.crypto_wallet if model else '' }}" placeholder="e.g., 0x742d35Cc6634C0532925a3b844Bc9e7595f42e" />
        </div>
        <div class="form-actions">
            <button class="button" type="submit">Save</button>
            <a class="button secondary" href="/models">Cancel</a>
        </div>
    </form>
</section>
<template id="adjustment-row-template">
    <div class="adjustment-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: end;">
        <div>
            <div style="font-size: 0.8rem; font-weight: 600; margin-bottom: 4px;">Effective Date</div>
            <input name="adjustment_effective_dates" type="date" required />
        </div>
        <div>
            <div style="font-size: 0.8rem; font-weight: 600; margin-bottom: 4px;">Monthly Amount</div>
            <input name="adjustment_amounts" type="number" step="0.01" min="0.01" required />
        </div>
        <div>
            <div style="font-size: 0.8rem; font-weight: 600; margin-bottom: 4px;">Notes (Optional)</div>
            <input name="adjustment_notes" type="text" />
        </div>
        <button type="button" class="button tertiary" data-remove-adjustment>Remove</button>
    </div>
</template>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const container = document.querySelector('[data-adjustments]');
    const addButton = document.getElementById('add-adjustment');
    const template = document.getElementById('adjustment-row-template');
    if (!container || !addButton || !template) {
        return;
    }
    const syncRemoveButtons = () => {
        const rows = container.querySelectorAll('.adjustment-row');
        rows.forEach((row) => {
            const removeButton = row.querySelector('[data-remove-adjustment]');
            if (removeButton) {
                removeButton.disabled = rows.length === 1;
            }
        });
    };
    addButton.addEventListener('click', () => {
        const clone = template.content.firstElementChild.cloneNode(true);
        container.appendChild(clone);
        syncRemoveButtons();
    });
    container.addEventListener('click', (event) => {
        const trigger = event.target.closest('[data-remove-adjustment]');
        if (!trigger) {
            return;
        }
        const rows = container.querySelectorAll('.adjustment-row');
        if (rows.length <= 1) {
            return;
        }
        trigger.closest('.adjustment-row').remove();
        syncRemoveButtons();
    });
    syncRemoveButtons();
});
</script>
{% endblock %}
