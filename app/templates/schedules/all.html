{% extends "base.html" %}
{% block title %}All Payroll Runs · Payroll Desk{% endblock %}

{% macro render_run_card(run, allow_delete=False) %}
<article class="run-card">
    <div class="run-card__header">
        <div class="run-card__titles">
            <span class="run-card__cycle">{{ run.cycle }}</span>
            <span class="run-card__meta">Created {{ run.created }}</span>
        </div>
        <span class="status-chip status-chip--{{ run.status_variant|default('neutral') }}">{{ run.status }}</span>
    </div>
    <div class="run-card__metrics">
        <div>
            <span class="run-card__metric-label">Total</span>
            <span class="run-card__metric-value">{{ run.currency or 'USD' }} {{ '%.2f'|format(run.total or 0) }}</span>
        </div>
        <div>
            <span class="run-card__metric-label">Paid</span>
            <span class="run-card__metric-value">{{ run.currency or 'USD' }} {{ '%.2f'|format(run.paid or 0) }}</span>
        </div>
        {% set outstanding_value = run.outstanding or 0 %}
        <div>
            <span class="run-card__metric-label">Outstanding</span>
            <span class="run-card__metric-value{% if outstanding_value > 0 %} is-warning{% endif %}">{{ run.currency or 'USD' }} {{ '%.2f'|format(outstanding_value) }}</span>
        </div>
        <div>
            <span class="run-card__metric-label">Models Paid</span>
            <span class="run-card__metric-value">{{ run.models_paid or 0 }}</span>
        </div>
    </div>
    <div class="run-card__frequencies">
        {% if run.frequency_counts %}
            {% for name, count in run.frequency_counts|dictsort %}
            <span class="frequency-chip">{{ name|replace('_', ' ')|title }} · {{ count }}</span>
            {% endfor %}
        {% else %}
        <span class="run-card__empty">No payout cadence recorded.</span>
        {% endif %}
    </div>
    <div class="run-card__actions">
        <a class="link-button" href="/schedules/{{ run.id }}">Open</a>
        {% if allow_delete %}
        <form method="post" action="/schedules/{{ run.id }}/delete" onsubmit="return confirm('Delete this payroll run?');">
            <button class="link-button danger" type="submit">Delete</button>
        </form>
        {% endif %}
    </div>
</article>
{% endmacro %}

{% block content %}
<section class="page-header">
    <div>
        <h1 class="page-title">All Payroll Runs</h1>
        <p>Browse every payroll cycle for {{ year }}.</p>
    </div>
    <div class="header-actions">
        <a class="button secondary" href="/schedules">Back to Dashboard</a>
        <a class="button secondary" href="{{ table_view_url }}">Table View</a>
        {% if user.role == 'admin' %}
        <a class="button" href="/schedules/new">Run Payroll</a>
        {% endif %}
    </div>
</section>

<section class="card">
    <div class="section-heading">
        <div>
            <h2>Select Year</h2>
            <p>Jump to a different archive of runs.</p>
        </div>
    </div>
    <form class="year-filter" method="get">
        <div class="year-filter__group">
            <label for="year-select">Year</label>
            <select id="year-select" name="year">
                {% for option in available_years %}
                <option value="{{ option }}" {% if option == year %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="year-filter__actions">
            <button class="button" type="submit">Update</button>
        </div>
    </form>
    {% if month_totals %}
    <div class="frequency-summary month-summary">
        {% for item in month_totals %}
        <a class="frequency-chip{% if not item.has_runs %} is-empty{% endif %}" href="/schedules?month={{ item.month_value }}">
            {{ item.label }} · {{ item.count }}
        </a>
        {% endfor %}
    </div>
    {% endif %}
</section>

<section class="card">
    <div class="section-heading">
        <div>
            <h2>Payroll Runs</h2>
            <p>{{ runs|length }} run{% if runs|length != 1 %}s{% endif %} recorded for {{ year }}.</p>
        </div>
    </div>
    {% if runs %}
    <div class="run-grid">
        {% for run in runs %}
        {{ render_run_card(run, user.role == 'admin') }}
        {% endfor %}
    </div>
    {% else %}
    <p class="empty-state">No payroll runs were recorded for {{ year }}.</p>
    {% endif %}
</section>
{% endblock %}
